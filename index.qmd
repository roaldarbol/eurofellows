---
title: |
  Fellowships <span style="font-size: 80% !important;">in</span> \
  Europe
description-title: |
  A dashboard for European fellowship opportunities with filtering and search capabilities.
format: 
  html:
    page-layout: full
    backgroundcolor: "#E6EEFF"
    css: styles.css
    header-includes: |
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

      <script async data-nf='{"formurl":"https://opnform.com/forms/european-fellowships-gqocnm","emoji":"ðŸ“","position":"right","bgcolor":"#3B82F6","width":800}' src='https://opnform.com/widgets/embed-min.js'></script>
      <script src="site_libs/strftime-0.9.2/strftime-min.js"></script>
      <script src="site_libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>
toc: false
title-block-banner: "linear-gradient(rgba(0, 51, 153, 1), rgba(230, 238, 255, 0.3)), url('assets/eu.jpg')"
---

```{r setup}
#| include: FALSE

# Load required packages
library(dplyr)
library(reactable)
library(htmltools)
library(jsonlite)
library(readxl)
library(crosstalk)
library(janitor)
library(stringr)
library(lubridate)
library(fontawesome)

# Source filter functions
source("R/filters.R")
source("R/card-renderer.R")

set.seed(123)
```

```{r load-data}
#| include: FALSE
data <- vroom::vroom("data/european-fellowships.csv") |> 
  dplyr::arrange(application_deadline) |> 
  dplyr::mutate(eligible_fields = if_else(is.na(eligible_fields), "Any field", eligible_fields),
                # application_deadline = as.Date(application_deadline, tz = "UTC")
                )
```

```{r setup-crosstalk}
#| include: FALSE
# Create shared data objects for crosstalk filtering
shared_fellowships <- SharedData$new(data)
```

```{r create-table}
#| include: FALSE

# Create the main reactable
fellowship_table <- reactable(
  shared_fellowships,
  elementId = "fellowship_table",
  filterable = FALSE,
  searchable = FALSE,
  highlight = FALSE,
  striped = FALSE,
  wrap = TRUE,
  class = "fellowship-table enhanced-cards",  # Added "enhanced-cards" class
  pagination = TRUE,
  defaultPageSize = 12,
  
  columns = list(
    fellowship_title = colDef(
      name = "Fellowships",
      cell = render_fellowship_card,
      html = TRUE
    ),
    # Hide all other columns
    id = colDef(show = FALSE),
    career_stage = colDef(show = FALSE),
    fellowship_funder = colDef(show = FALSE),
    fellowship_url = colDef(show = FALSE),
    fellowship_duration = colDef(show = FALSE),
    application_deadline = colDef(show = FALSE),
    eligible_host_location = colDef(show = FALSE),
    eligible_institution = colDef(show = FALSE),
    eligible_nationalities = colDef(show = FALSE),
    eligible_fields = colDef(show = FALSE),
    field_category_major = colDef(show = FALSE),
    field_category_minor = colDef(show = FALSE),
    requires_mobility = colDef(show = FALSE),
    requires_phd = colDef(show = FALSE),
    requires_publication = colDef(show = FALSE),
    minimum_years_post_phd = colDef(show = FALSE),
    maximum_years_post_phd = colDef(show = FALSE),
    contributor_name = colDef(show = FALSE),
    contributor_url = colDef(show = FALSE),
    comments = colDef(show = FALSE),
    date_created = colDef(show = FALSE),
    date_updated = colDef(show = FALSE)
  ),
  
  rowStyle = list(cursor = "default"),
  theme = reactableTheme(
    cellPadding = "0px",  # Removed padding to let cards handle their own spacing
    searchInputStyle = list(width = "100%")
  )
)
```

```{r create-ui}
#| echo: FALSE

# Assemble the complete UI
div(
  class = "fellowships",
  create_compact_filters(shared_fellowships),
  tags$hr(),
  
  # Fellowship cards table
  fellowship_table,
  htmltools::browsable(
    tags$button(class = "download-btn", 
                tags$label(class = "filter-label-download",
                           tags$span(class = "filter-icon", 
                                     fa("download")), 
                           "Download as CSV"), 
                onclick = "Reactable.downloadDataCSV('fellowship_table', 'european-fellowships.csv')")
    )
)
```

```{js echo=FALSE}
function filter_default() {
    document.getElementById("career_stage").getElementsByClassName("selectized")
    [0].selectize.setValue("Postdoc", true);
    document.getElementById("career_stage").getElementsByClassName("selectized")
    [0].selectize.setValue("PhD", true);
 }
window.onload = filter_default;
```