---
title: |
  European Fellowship Index
description-title: |
  A dashboard for European fellowship opportunities with filtering and search capabilities.
format: 
  html:
    page-layout: full
    backgroundcolor: "#E6EEFF"
    css: styles.css
    header-includes: |
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

      <script async data-nf='{"formurl":"https://opnform.com/forms/european-fellowships-gqocnm","emoji":"ðŸ“","position":"right","bgcolor":"#3B82F6","width":800}' src='https://opnform.com/widgets/embed-min.js'></script>
      <script src="site_libs/strftime-0.9.2/strftime-min.js"></script>
      <script src="site_libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>
      <!-- 100% privacy-first analytics -->
      <script data-collect-dnt="true" async src="https://scripts.simpleanalyticscdn.com/latest.js"></script>
      <noscript><img src="https://queue.simpleanalyticscdn.com/noscript.gif?collect-dnt=true" alt="" referrerpolicy="no-referrer-when-downgrade"/></noscript>
toc: false
title-block-banner: "linear-gradient(rgba(0, 51, 153, 1), rgba(0, 51, 153, 0.3))"
---

```{r setup}
#| include: FALSE

# Load required packages
library(dplyr)
library(purrr)
library(reactable)
library(htmltools)
library(jsonlite)
library(readxl)
library(crosstalk)
library(janitor)
library(stringr)
library(stringi)
library(lubridate)
library(fontawesome)

# Source filter functions
source("R/custom_filters.R")
source("R/filters.R")
source("R/card-renderer.R")

set.seed(123)
```

```{r load-data}
#| include: FALSE
data <- vroom::vroom("data/european-fellowships.csv") |>
  dplyr::filter(career_stage == "Postdoc") |> 
  dplyr::mutate(
    dplyr::across(
      dplyr::where(~ is.character(.x) && any(grepl(",", .x, fixed = TRUE), na.rm = TRUE)) & !matches("comments") & !matches("fellowship_title"),
      ~ strsplit(.x, ",") |> map(~ trimws(.x)),
      .names = "{.col}"
    )
  ) |> 
  dplyr::mutate(application_deadline_rolling = if_else(
    is.na(application_deadline), 
    TRUE,
    FALSE
  ),
  application_deadline = if_else(
    is.na(application_deadline), 
    lubridate::today(),
    application_deadline
  )) |> 
  dplyr::filter(application_deadline >= lubridate::today()) |>
  dplyr::mutate(starting_grant = if_else(starting_grant == TRUE,
                                         "Starting Grant",
                                         "Fellowship")) |> 
  dplyr::arrange(
    desc(application_deadline_rolling), 
    application_deadline,
    host_country,
    fellowship_duration,
    )
```

```{r setup-crosstalk}
#| include: FALSE

# Shared data for reactable
shared_data <- SharedData$new(data)

# Create shared data objects for crosstalk filtering
shared_fellowships <- SharedData$new(data, group = shared_data$groupName())
```

```{r create-table}
#| include: FALSE

# Create the main reactable
fellowship_table <- reactable(
  shared_data,
  elementId = "fellowship_table",
  filterable = FALSE,
  searchable = FALSE,
  highlight = FALSE,
  striped = FALSE,
  wrap = TRUE,
  class = "fellowship-table enhanced-cards",  # Added "enhanced-cards" class
  pagination = TRUE,
  defaultPageSize = 12,
  showPageSizeOptions = TRUE,
  pageSizeOptions = c(12, 24, 100),
  
  columns = list(
    fellowship_title = colDef(
      name = "Fellowships",
      cell = render_fellowship_card,
      html = TRUE
    ),
    # Hide all other columns
    id = colDef(show = FALSE),
    career_stage = colDef(show = FALSE),
    fellowship_funder = colDef(show = FALSE),
    fellowship_url = colDef(show = FALSE),
    fellowship_duration = colDef(show = FALSE),
    starting_grant = colDef(show = FALSE),
    application_deadline = colDef(show = FALSE),
    application_deadline_rolling = colDef(show = FALSE),
    host_country = colDef(show = FALSE),
    host_institution = colDef(show = FALSE),
    connection_type = colDef(show = FALSE),
    connection_in_or_not = colDef(show = FALSE),
    connection_country = colDef(show = FALSE),
    academic_field = colDef(show = FALSE),
    academic_field_category_major = colDef(show = FALSE),
    academic_field_category_minor = colDef(show = FALSE),
    requires_mobility = colDef(show = FALSE),
    requires_phd = colDef(show = FALSE),
    requires_publication = colDef(show = FALSE),
    minimum_years_post_phd = colDef(show = FALSE),
    maximum_years_post_phd = colDef(show = FALSE),
    contributor_name = colDef(show = FALSE),
    contributor_url = colDef(show = FALSE),
    comments = colDef(show = FALSE),
    date_created = colDef(show = FALSE),
    date_updated = colDef(show = FALSE)
  ),
  
  # rowStyle = list(cursor = "default"),
  rowStyle = function(index) {
    # Hide duplicate rows at the row level
    current_row <- shared_fellowships$data()[index, ]
    all_current_data <- shared_fellowships$data()
    first_occurrence_index <- which(all_current_data$id == current_row$id)[1]
    
    if (index != first_occurrence_index) {
      list(display = "none")
    } else {
      list(cursor = "default")
    }
  },
  theme = reactableTheme(
    cellPadding = "0px",  # Removed padding to let cards handle their own spacing
    searchInputStyle = list(width = "100%")
  )
)
```

```{r create.ui}
#| echo: false
# Assemble the complete UI
div(
  class = "fellowships",
  create_compact_filters(shared_fellowships),
  tags$hr(),
  
  # Fellowship cards table
  fellowship_table,
  
  # Download button
  htmltools::browsable(
    tags$button(class = "download-btn", 
                tags$label(class = "filter-label-download",
                           tags$span(class = "filter-icon", 
                                     fa("download")), 
                           "Download as CSV"), 
                onclick = "Reactable.downloadDataCSV('fellowship_table', 'european-fellowships.csv')")
    )
)
```

```{r phd-checkbox}
#| eval: FALSE 
#| include: FALSE

function filter_default() {
    document.getElementById("career_stage").getElementsByClassName("selectized")[0].selectize.setValue("Postdoc", true);
    document.getElementById("career_stage").getElementsByClassName("selectized")[0].selectize.setValue("PhD", true);
 }
window.onload = filter_default;
```
